<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Werewolf Online üê∫</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --bg: #1a1a1a; --night: #2980b9; --day: #f1c40f; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); color: #ddd; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: #222; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 100%; max-width: 420px; text-align: center; border: 1px solid #444; }
        .hidden { display: none; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #444; border-radius: 8px; font-size: 16px; background: #333; color: white; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-black { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: white; }
        .btn-phase { background: #8e44ad; color: white; margin-top: 15px; }
        .room-code-tag { font-size: 2rem; font-weight: bold; letter-spacing: 5px; color: var(--accent); margin: 10px 0; border: 2px solid #555; display: inline-block; padding: 0 15px; }
        .player-badge { background: #333; padding: 8px 15px; margin: 5px; border-radius: 20px; display: inline-block; border: 1px solid #555; }
        #timer { font-size: 3.5rem; font-weight: bold; margin: 10px 0; font-family: monospace; color: var(--day); }
        .phase-indicator { font-size: 1.2rem; font-weight: bold; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .phase-night { background: #2980b9; color: white; }
        .phase-day { background: #f1c40f; color: #333; }
        .phase-vote { background: #e74c3c; color: white; }
        .role-box { padding: 20px; border: 3px dashed #555; margin: 15px 0; border-radius: 10px; background: #2a2a2a; }
        #my-role { font-size: 1.8rem; margin: 10px 0; }
    </style>
</head>
<body>

<div class="card">
    <div id="home-screen">
        <h1 style="color: var(--accent);">WEREWOLF üê∫</h1>
        <input type="text" id="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
        <input type="text" id="room-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á 4 ‡∏´‡∏•‡∏±‡∏Å" maxlength="4">
        <button class="btn-black" id="btn-create">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á (Host)</button>
        <button class="btn-outline" id="btn-join">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á (Join)</button>
    </div>

    <div id="lobby-screen" class="hidden">
        <p>‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: <span class="room-code-tag" id="display-code">----</span></p>
        <div id="player-list"></div>
        <div id="host-controls" class="hidden">
            <p>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</p>
            <select id="time-select">
                <option value="60">1 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
                <option value="180">3 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
                <option value="300">5 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
            </select>
            <button class="btn-phase" style="background: #27ae60;" id="btn-start-game">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡πÅ‡∏à‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó)</button>
        </div>
        <p id="wait-msg">‚åõ ‡∏£‡∏≠ Host ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</p>
    </div>

    <div id="game-screen" class="hidden">
        <div id="phase-label" class="phase-indicator">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô</div>
        <div id="timer">00:00</div>
        
        <div class="role-box">
            <p style="margin:0">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <h2 id="my-role">...</h2>
            <p id="role-desc" style="font-size: 0.9rem; color: #aaa;"></p>
        </div>

        <div id="host-game-controls" class="hidden">
            <p>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Host:</p>
            <button class="btn-outline" id="next-phase-btn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏Ñ‡∏∑‡∏ô > ‡πÄ‡∏ä‡πâ‡∏≤ > ‡πÇ‡∏´‡∏ß‡∏ï)</button>
            <button class="btn-black" id="end-game-btn">‡∏à‡∏ö‡πÄ‡∏Å‡∏°/‡∏•‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        // ‡πÉ‡∏ä‡πâ Config ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        apiKey: "AIzaSyBemaycCfIrcNWlnZPas_Y19UZJg_x7f64",
        authDomain: "insider-2b1e8.firebaseapp.com",
        databaseURL: "https://insider-2b1e8-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "insider-2b1e8",
        storageBucket: "insider-2b1e8.firebasestorage.app",
        messagingSenderId: "401183902279",
        appId: "1:401183902279:web:e10be99798a90a69ce3f62"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myName = "", currentRoom = "", isHost = false, timerInterval = null;
    const phases = ["NIGHT", "DAY", "VOTE"];

    function showScreen(id) {
        document.querySelectorAll('.card > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á ---
    document.getElementById('btn-create').onclick = async () => {
        myName = document.getElementById('username').value.trim();
        if (!myName) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏à‡πâ‡∏≤");
        isHost = true;
        currentRoom = Math.floor(1000 + Math.random() * 9000).toString();
        await set(ref(db, 'rooms/' + currentRoom), { 
            status: 'waiting', 
            host: myName, 
            players: { [myName]: "waiting" },
            phase: 0,
            timeLeft: 0
        });
        initRoomListener();
    };

    document.getElementById('btn-join').onclick = async () => {
        myName = document.getElementById('username').value.trim();
        currentRoom = document.getElementById('room-input').value.trim();
        if (!myName || currentRoom.length < 4) return alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á");
        await update(ref(db, `rooms/${currentRoom}/players`), { [myName]: "waiting" });
        initRoomListener();
    };

    function initRoomListener() {
        onValue(ref(db, 'rooms/' + currentRoom), (snapshot) => {
            const data = snapshot.val();
            if (!data) return location.reload();

            const players = data.players ? Object.keys(data.players) : [];
            document.getElementById('display-code').innerText = currentRoom;
            document.getElementById('player-list').innerHTML = players.map(p => `<span class="player-badge">${p}</span>`).join('');

            if (isHost) {
                document.getElementById('host-controls').classList.remove('hidden');
                document.getElementById('wait-msg').classList.add('hidden');
            }

            if (data.status === 'playing') {
                renderGame(data);
            } else {
                showScreen('lobby-screen');
            }
        });
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó ---
    document.getElementById('btn-start-game').onclick = () => {
        const players = Object.keys(playersInRoomList); // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ
        if (players.length < 3) return alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

        let roles = {};
        let shuffled = [...players].sort(() => Math.random() - 0.5);
        
        // ‡∏™‡∏∏‡πà‡∏°‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤ 1 ‡∏ï‡∏±‡∏ß (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°)
        roles[shuffled[0]] = "WEREWOLF";
        // ‡∏™‡∏∏‡πà‡∏°‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå 1 ‡∏ï‡∏±‡∏ß
        roles[shuffled[1]] = "SEER";
        // ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô
        for(let i=2; i<shuffled.length; i++) {
            roles[shuffled[i]] = "VILLAGER";
        }

        update(ref(db, 'rooms/' + currentRoom), {
            status: 'playing',
            roles: roles,
            phase: 0, // 0: Night, 1: Day, 2: Vote
            timeLeft: parseInt(document.getElementById('time-select').value)
        });
    };

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢
    let playersInRoomList = {};
    onValue(ref(db, `rooms/${currentRoom}/players`), (snap) => { playersInRoomList = snap.val() || {}; });

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° ---
    function renderGame(data) {
        showScreen('game-screen');
        const myRole = data.roles[myName];
        const roleDisplay = document.getElementById('my-role');
        const roleDesc = document.getElementById('role-desc');
        const phaseLabel = document.getElementById('phase-label');

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
        roleDisplay.innerText = myRole === "WEREWOLF" ? "‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤ üê∫" : (myRole === "SEER" ? "‡∏ô‡∏±‡∏Å‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå üîÆ" : "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô üë®‚Äçüåæ");
        roleDisplay.style.color = myRole === "WEREWOLF" ? "#e74c3c" : "#3498db";
        roleDesc.innerText = getRoleHint(myRole);

        // ‡πÅ‡∏™‡∏î‡∏á Phase
        const phaseNames = ["‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô", "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ ‚òÄÔ∏è", "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏ß‡∏ï ‚öñÔ∏è"];
        const phaseClasses = ["phase-night", "phase-day", "phase-vote"];
        phaseLabel.innerText = phaseNames[data.phase];
        phaseLabel.className = "phase-indicator " + phaseClasses[data.phase];

        if (isHost) {
            document.getElementById('host-game-controls').classList.remove('hidden');
            handleTimerHost(data.timeLeft);
        } else {
            updateTimerUI(data.timeLeft);
        }
    }

    function getRoleHint(role) {
        if(role === "WEREWOLF") return "‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ";
        if(role === "SEER") return "‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ";
        return "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏à‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏ä‡πâ‡∏≤";
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Phase ---
    function handleTimerHost(seconds) {
        if (timerInterval) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Loop ‡∏ã‡πâ‡∏≥
        timerInterval = setInterval(() => {
            onValue(ref(db, `rooms/${currentRoom}/timeLeft`), (snap) => {
                let currentT = snap.val();
                if (currentT > 0) {
                    update(ref(db, `rooms/${currentRoom}`), { timeLeft: currentT - 1 });
                    updateTimerUI(currentT - 1);
                }
            }, { onlyOnce: true });
        }, 1000);
    }

    function updateTimerUI(seconds) {
        const m = Math.floor(seconds / 60), s = seconds % 60;
        document.getElementById('timer').innerText = `${m}:${s.toString().padStart(2, '0')}`;
    }

    document.getElementById('next-phase-btn').onclick = () => {
        onValue(ref(db, `rooms/${currentRoom}`), (snap) => {
            const data = snap.val();
            let nextPhase = (data.phase + 1) % 3;
            update(ref(db, `rooms/${currentRoom}`), { 
                phase: nextPhase,
                timeLeft: 60 // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡πà‡∏ß‡∏á
            });
        }, { onlyOnce: true });
    };

    document.getElementById('end-game-btn').onclick = () => {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Lobby ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            clearInterval(timerInterval);
            timerInterval = null;
            update(ref(db, 'rooms/' + currentRoom), { status: 'waiting' });
        }
    };
</script>
</body>
</html>
